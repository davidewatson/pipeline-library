# Table of Contents

<!-- MarkdownTOC depth=4 autolink=true bracket=round -->

- [CNCT shared workflow library](#cnct-shared-workflow-library)
  - [Jenkins Helm chart](#jenkins-helm-chart)
  - [Job configurations](#job-configurations)
  - [Shared workflow library defaults](#shared-workflow-library-defaults)
  - [Shared workflow library code](#shared-workflow-library-code)
  - [Helm chart GitHub repositories](#helm-chart-github-repositories)
  - [Repository structure:](#repository-structure)
    - [.versionfile](#versionfile)
    - [pipeline.yaml](#pipelineyaml)
      - [type](#type)
      - [beforeScript](#beforescript)
      - [afterScript](#afterscript)
      - [envValues](#envvalues)
      - [slack](#slack)
      - [vault](#vault)
      - [helm](#helm)
      - [pullSecrets](#pullsecrets)
      - [rootfs](#rootfs)
      - [configs](#configs)
      - [test](#test)
      - [stage](#stage)
      - [prod](#prod)
    - [Pipeline yaml example](#pipeline-yaml-example)
  - [User scripts](#user-scripts)
  - [Pipeline flow](#pipeline-flow)
  - [Common problems](#pipeline-flow)
    - [Problems with chart labels](#problems-with-chart-labels)

<!-- /MarkdownTOC -->

# CNCT shared workflow library

The [shared workflow library](https://jenkins.io/doc/book/pipeline/shared-libraries/) in this repository is a library of reusable Groovy code, that is reused my multiple jenkins jobs/pipelines in order to test, build and deploy Kubernetes Helm chartds. A full CNCT pipeline consists of:

* Jenkins Helm chart
* Job configuration files written in the Groovy language, stored in a separate org-specific git repo.
* Shared workflow library defaults
* Shared workflow library code
* Helm chart GitHub repositories

Individual chart pipelines are configured through required `pipeline.yaml` and `.versionfile` files

## Jenkins Helm chart

Helm chart that deploys Jenkins CI, optionally configuring CNCT shared workflow library as a [global shared library](https://jenkins.io/doc/book/pipeline/shared-libraries/#global-shared-libraries)

See https://github.com/samsung-cnct/pipeline-jenkins for an example setup 

## Job configurations

All pipeline configuration files are described in below sections in detail. *They live in a separate, organization-specific repository.* 

There is no particular convention enforced on the job configurations by the library, as long as Jenkins jobs generated by the configurations refer to, and execute the pipeline library:

```
@Library('pipeline')
import import io.cnct.pipeline.*
new cnctPipeline().execute()
```

See https://github.com/samsung-cnct/pipeline-jobs for an example setup

## Shared workflow library defaults

Defaults are located in the [resources](resources/io/cnct/pipeline/defaults.yaml) folder.

These specify default values for pipeline runs. Some of the values can only be specified in the defaults file, some can be overwritten by the individual repository configurations.

Setting | Description
--- | ---
jenkinsNamespace | Kubernetes namespace of Jenkins agent pods 
prodNamespace | 'Production' kubernetes namespace
stageNamespace | 'Staging' kubernetes namespace
serviceAccount | Jenkins Kubernetes service account
doDeploy | Deploy to prod on merge: `none` never; `versionfile` when version file changes; `auto` always
retries | Number of retries on deploys and tests
timeout | Helm timeout
versionfile | Name of a version file required for every pipeline application repository
shell | Default shell for script execution
slack.channel | Default notification channel
slack.credentials | Jenkins slack credentials id
slack.domain | Slack team domain 
image.dind | Default image for docker-in-docker container
image.docker | Default image for docker client container
image.helm | Default image for helm client container
image.vault | Default image for vault client container
image.script | Default image for script container
vault.server | Vault server URL
vault.credentials | Id of hashicorp vault token credentials from Jenkins deployment
vault.api | Vault API version
vault.tls.secret | Name of kubernetes secret containing vault client TLS certs 
vault.tls.cert | Name of client cert in the client TLS secret 
vault.tls.key | Name of client key in the client TLS secret
vault.tls.ca | Name of CA cert in the client TLS secret
helm.namespace | Tiller namespace
helm.registry | URL of chart museum API
docker.registry | Docker registry to use
docker.credentials | Id of docker registry username and password credentials from Jenkins deployment
docker.testTag | Additonal tag for test stage images
docker.stageTag | Additonal tag for staging stage images 
docker.prodTag | Additonal tag for prod stage images

Example:

```
jenkinsNamespace: prod
prodNamespace: prod
stageNamespace: staging
serviceAccount: jenkins
doDeploy: none
retries: 1
timeout: 600
versionfile: .versionfile
shell: sh
slack:
  channel: #team-migrations
  credentials: slack-access
  domain: "samsung-cnct"
images: 
  dind: docker:stable-dind
  docker: docker:stable
  helm: quay.io/maratoid/helm:latest
  vault: quay.io/maratoid/vault:latest
  script: quay.io/maratoid/script:latest
vault:
  server: http://vault-access.maratoid.svc.cluster.local
  credentials: vault-plugin
  api: v1
  tls:
    secret: "vault-client-tls"
    cert: "vault-client.pem"
    key: "vault-client-key.pem"
    ca: "ca.pem"
helm:
  namespace: kube-system
  registry: http://museum-chartmuseum.maratoid.svc.cluster.local:8080
docker:
  registry: quay.io
  credentials: docker-creds
  testTag: test
  stageTag: staging
  prodTag: prod
```

## Shared workflow library code

Workflow library code is a set of groovy classes located under [src/io/cnct/pipeline](src/io/cnct/pipeline)  
Individual repository `Jenkinsfile`s can reference it either by setting up a global shared workflow under Jenkins, or 
importing the library individually and starting it via 

```
@Library('pipeline')
import import io.cnct.pipeline.*
new cnctPipeline().execute()
```

## Helm chart GitHub repositories

Helm chart github repositories are the individual Helm charts built byt the pipeline library. Library imposes some requirements on the repositories it is targeted at:

## Repository structure:

Example:

```
repository root
  charts
    chart-name
      chart contents
    chart-name
      chart-contents
  rootfs
    fs-contents-folder
      Dockerfile
    fs-contents-folder
      Dockerfile
  pipeline.yaml
  .versionfile
```

Neither `charts` nor `rootfs` are required. I.e. you can have a repository that builds charts but not docker images, only docker images or both charts and docker images. All charts under `charts` and all docker images under `rootfs` will be versioned using .versionfile contents.

### .versionfile

Actual name is configurable via shared workflow library defaults. Required.  
Contents are:

```
Major.Minor.Build
```

For example:

```
1.1.2
```

Contents serve as a component or both docker tags and full [SemVer](https://semver.org/) version number for built charts.


### pipeline.yaml

Cofiguration for each individual pipeline.  


#### type

Type of pipeline. Currently only `chart` is supported

Setting | Description
--- | ---
type | Type of pipeline

#### beforeScript

Global 'Before' script to be executed. Executed after environment variable injection and pull secret creation.

Setting | Description
--- | ---
beforeScript.image | docker image to use.
beforeScript.script | path to script file to run relative to current workspace
beforeScript.shell | Which shell to use for execution

#### afterScript

Global 'After' script to be executed. Executed after everything else in the pipeline finished.

Setting | Description
--- | ---
afterScript.image | docker image to use.
afterScript.script | path to script file to run relative to current workspace
afterScript.shell | Which shell to use for execution

#### envValues

Environment values to be injected. Can be straight values, or references to a value from Vault K/V.

Setting | Description
--- | ---
envValues | Array of environment variable definitions
envValues.[].envVar | Variable name
envValues.[].value | Variable value
envValues.[].secret | Path to Vault K/V value. I.e `kv-backend/kv-name/kv-value-name`

#### slack

SLack notification info.

Setting | Description
--- | ---
slack.channel | channel for notifications

#### vault

Vault server information

Setting | Description
--- | ---
vault.server | Vault server URL
vault.credentials | Jenkins vault token credential ID

#### helm

Helm namespace information

Setting | Description
--- | ---
helm.namespace | Tiller namespace

#### pullSecrets

Kubernetes image pull secrets to create, in case some of the docker images used in the pipeline building process are in private repositories. Do not apply to the image BEING built, just images used FOR BUILDING.

Setting | Description
--- | ---
pullSecrets | Array of pull secret objects
pullSecrets.[].name | pull secret name
pullSecrets.[].server | Registry server
pullSecrets.[].username | Registry user name
pullSecrets.[].email | Registry email
pullSecrets.[].password | Path to Vault K/V value containing registry password. I.e `kv-backend/kv-name/kv-value-name`


#### rootfs 

Array of images to be built under `rootfs` folder, and how they relate to Helm values of charts under `charts`

Setting | Description
--- | ---
rootfs | Array of rootfs objects
rootfs.[].image | image to build, without the `:tag`
rootfs.[].buildArgs | Array of `name: value` build args for the image
rootfs.[].context | Path, relative to current workspace, to which rootfs folder build this image. I.e. `/something/under/rootfs`
rootfs.[].chart | Name of the chart using this image, under `charts`
rootfs.[].value | Dot-path to value under the chart's values.yaml that sets this image for the chart. I.e. `section.image.myawesomecontainer`

#### configs

Pipeline stage configurations

Setting | Description
--- | ---
configs | Array of pipeline stage configurations objects
configs.[].chart | Chart name under `charts`
configs.[].timeout | Helm timeout for things like helm tests
configs.[].retries | Humber of retries for things like helm tests
configs.[].release | Helm prod release name
configs.[].test.values | Array of override values for test stage. Can be straight values, or references to a value from Vault K/V.
configs.[].test.values.[].key | Name of helm value. I.e. `some.key.somewhere`
configs.[].test.values.[].value | Value to use
configs.[].test.values.[].secret | Path to Vault K/V value containing the value. I.e `kv-backend/kv-name/kv-value-name`
configs.[].stage.values | Array of override values for staging stage. Can be straight values, or references to a value from Vault K/V.
configs.[].stage.values.[].key | Name of helm value. I.e. `some.key.somewhere`
configs.[].stage.values.[].value | Value to use
configs.[].stage.values.[].secret | Path to Vault K/V value containing the value. I.e `kv-backend/kv-name/kv-value-name`
configs.[].stage.tests | Array of test scripts to run as part of staging tests
configs.[].stage.tests.[].image | Docker image to use
configs.[].stage.tests.[].shell | Shell to use for running the script
configs.[].stage.tests.[].script | Path to script file to run relative to current workspace
configs.[].prod.values | Array of override values for prod stage. Can be straight values, or references to a value from Vault K/V.
configs.[].prod.values.[].key | Name of helm value. I.e. `some.key.somewhere`
configs.[].prod.values.[].value | Value to use
configs.[].prod.values.[].secret | Path to Vault K/V value containing the value. I.e `kv-backend/kv-name/kv-value-name`

#### test 

Addtitional test stage actions

Setting | Description
--- | ---
test.beforeScript | Script info to execute before test deployment
test.beforeScript.image | Docker image to use for running the script
test.beforeScript.shell | Shell to use for running the script
test.beforeScript.script | Path to script file to run relative to current workspace
test.afterScript | Script info to execute before test deployment
test.afterScript.image | Docker image to use for running the script
test.afterScript.shell | Shell to use for running the script
test.afterScript.script | Path to script file to run relative to current workspace

#### stage 

Addtitional staging stage actions

Setting | Description
--- | ---
stage.beforeScript | Script info to execute before staging deployment
stage.beforeScript.image | Docker image to use for running the script
stage.beforeScript.shell | Shell to use for running the script
stage.beforeScript.script | Path to script file to run relative to current workspace
stage.afterScript | Script info to execute before staging deployment
stage.afterScript.image | Docker image to use for running the script
stage.afterScript.shell | Shell to use for running the script
stage.afterScript.script | Path to script file to run relative to current workspace

#### prod 

Addtitional prod stage actions

Setting | Description
--- | ---
prod.beforeScript | Script info to execute before prod deployment
prod.beforeScript.image | Docker image to use for running the script
prod.beforeScript.shell | Shell to use for running the script
prod.beforeScript.script | Path to script file to run relative to current workspace
prod.afterScript | Script info to execute before prod deployment
prod.afterScript.image | Docker image to use for running the script
prod.afterScript.shell | Shell to use for running the script
prod.afterScript.script | Path to script file to run relative to current workspace
prod.doDeploy | Perform prod deployment condition. `none` - never. `versionfile` - only if versionfile changed. `auto` - always

### Pipeline yaml example

```
type: chart
beforeScript:
  script: scripts/globalBefore.sh
  shell: /bin/bash
afterScript:
  image: alpine:latest
  script: scripts/globalAfter.sh
pullSecrets:
  - name: quay
    server: quay.io
    username: maratoid
    email: maratoid@gmail.com
    password: secret/pull/quay
envValues:
  - envVar: BUSYBOX_SECRET_VARIABLE
    secret: secret/busybox/dummy
  - envVar: BUSYBOX_PLAIN_VARIABLE
    value: THIS-IS-A-DUMMY-PLAIN-VAR-FOR-TESTING
slack:
  channel: #team-migrations
rootfs:
  - image: maratoid/pipeline-busybox
    buildArgs: 
      TEST_ARG: "something not default"
    context: pipeline-busybox
    chart: pipeline-busybox
    value: images.image
configs:
  - chart: pipeline-busybox
    timeout: 600
    retries: 2
    release: pipeline-busybox
    test: 
      values:
        - key: pipeline.secretval
          secret: secret/busybox/dummy
        - key: pipeline.plainval
          value: THIS-IS-A-DUMMY-PLAIN-VAR-FOR-TESTING
    stage: 
      values:
        - key: pipeline.secretval
          secret: secret/busybox/dummy
        - key: pipeline.plainval
          value: THIS-IS-A-DUMMY-PLAIN-VAR-FOR-TESTING
      tests:
        - image: bash:latest
          script: scripts/stageTest.sh
          shell: /bin/bash
    prod: 
      values:
        - key: pipeline.secretval
          secret: secret/busybox/dummy
        - key: pipeline.plainval
          value: THIS-IS-A-DUMMY-PLAIN-VAR-FOR-TESTING
test:
  beforeScript:
    script: scripts/testBefore.sh
    shell: /bin/bash
  afterScript:
    image: alpine:latest
    script: scripts/testAfter.sh
stage:
  beforeScript:
    script: scripts/stageBefore.sh
    shell: /bin/bash
  afterScript:
    image: alpine:latest
    script: scripts/stageAfter.sh    
prod: 
  beforeScript:
    script: scripts/prodBefore.sh
    shell: /bin/bash
  afterScript:
    image: alpine:latest
    script: scripts/prodAfter.sh 
  doDeploy: versionfile
```

## User scripts

Pipeline will preserve user script containers with the same image name for the lifetime of pipeline run.
I.e. if you use `quay.io/myimage` for your global `beforeScript` and end up installing `kubectl` as a part of the script run,
`kubectl` will still be available in the `afterScript` proivided you used the same `quay.io/myimage` image.

## Pipeline flow

![pipeline flow](doc/pipeline.png)

## Common problems

### Problems with chart labels

Pipeline versions charts with SemVer metadata added to the version and will result in version numbers like `0.0.7-prod.6+e0e090463683f08ba3813704330308fe1aae0f01`

If your chart uses label values templated like `"chart: {{.Chart.Name }}-{{ .Chart.Version }}"` you will end up with a lable value that is invalid, due to the `+` character, or is too long.

Use something like `chart: {{ printf "%s-%s" .Chart.Name .Chart.Version | replace "+" "_" | trunc 63 }}` instead.
